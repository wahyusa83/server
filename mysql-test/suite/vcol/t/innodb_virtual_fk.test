source include/have_innodb.inc;
source include/have_sequence.inc;

set default_storage_engine=innodb;

#
# MDEV-13708 Crash with indexed virtual columns and FK cascading deletes
#

create table t1 (id int primary key, id2 int as (id) virtual, key id2 (id2));
create table t2 (id int key, constraint fk_id foreign key (id) references t1 (id) on delete cascade);
insert into t1 (id) values (1), (2);
insert into t2 (id) values (1), (2);
delete from t1;
select * from t1;
select * from t2;
drop table t2;
drop table t1;

--echo #
--echo # MDEV-29181 Potential corruption on FK update on a table with vcol index
--echo #

--connect (con2, localhost, root,,)
--connection default
create table t1 (a int primary key);
insert into t1(a) select * from seq_1_to_2048;
create table t2 (a int,  b int as (a), key(b), foreign key (a) references t1 (a)
  on update cascade);
insert into t2(a) select * from seq_1_to_2048;

send update t1 set a = a - 100000 where a < 1024;

--connection con2
set lock_wait_timeout =1;
update t1 set a= a + 1000000 where a > 1024;

--connection default
--reap

-- echo # LOAD DATA + VIEW
create view v1 as select a as va from t1;
select * into outfile 't1_out' from t1 where a = 1000000 + 2000;
--error ER_ROW_IS_REFERENCED_2
load data infile 't1_out' replace into table v1;

# Cleanup
drop view v1;
drop table t2, t1;
--disconnect con2

--echo # DROP FOREIGN KEY while concurrent prelocking is not finished
create table t1 (pk int primary key, a int, key(a)) engine=innodb;
create table t2 (pk int, b int references t1(a)
                   on delete cascade on update cascade) engine=innodb;

create table t3 (c int, foreign key(c) references t1(a)) engine=innodb;

insert into t1 values (1, 1), (2, 1), (3, 1);
insert into t2 values (1, 1);

--connect (con1,localhost,root,,test)
send update t1 set a = 6;

--connection default
alter table t2 add key(pk), drop foreign key t2_ibfk_1,
               algorithm=inplace, lock=none;

--connection con1
--reap
--connection default

#cleanup
drop table t2, t3, t1;

-- echo # UPDATE is started, but FK is ADDed concurrently
create table t1 (pk int primary key, a int, key(a)) engine=innodb;
create table t2 (b int) engine=innodb;

insert into t1 select *, 1 from seq_1_to_300;
insert into t2 values (1);

--connection con1
send update t1 set a = 6;

--connection default
set foreign_key_checks=off;
alter table t2 add foreign key(b) references t1(a)
               on delete cascade on update cascade,
               algorithm=inplace, lock=none;

--connection con1
--reap
--connection default

# Cleanup
--disconnect con1
drop table t2, t1;
